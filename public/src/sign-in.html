<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link href="../FreezeUI/freeze-ui.min.css" type="text/css" rel="stylesheet"/>
<dom-module id="sign-in">
  <template>
    <style>
      :host {
        display: block;
        font-family: Tahoma;
        padding: 0px;
      }
      .container {
        max-width: 450px;
        padding: 15px 35px 45px;
        margin: 0 auto;
        background-color: #fff;
        border: 1px solid rgba(0,0,0,0.1);  
        margin-top: 10px;
      }
      .success, .error {
        margin: 10px 0px;
        padding:12px;  
      }
      .success {
          color: #4F8A10;
          background-color: #DFF2BF;
          display: none;
      }
      .error {
          color: #D8000C;
          background-color: #FFD2D2;
          display: none;
      }

      .loader {
        border: 5px solid #f3f3f3;
        -webkit-animation: spin 1s linear infinite;
        animation: spin 1s linear infinite;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        margin: 0 auto;
        display: none;
      }

      /* Safari */
      @-webkit-keyframes spin {
        0% { -webkit-transform: rotate(0deg); }
        100% { -webkit-transform: rotate(360deg); }
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .return{
        float: right;
      }
      span {
        padding: 10px;
      }
      paper-button.indigo {
        background-color: var(--paper-indigo-500);
        color: white;
        --paper-button-raised-keyboard-focus: {
          background-color: var(--paper-indigo-500) !important;
          color: white !important;
        };
      }

      paper-checkbox.blue {
        --paper-checkbox-checked-color: var(--paper-blue-500);
        --paper-checkbox-checked-ink-color: var(--paper-blue-500);
        --paper-checkbox-unchecked-color: var(--paper-blue-900);
        --paper-checkbox-unchecked-ink-color: var(--paper-blue-900);
        --paper-checkbox-label-color: var(--paper-blue-700);
        --paper-checkbox-label-checked-color: var(--paper-blue-900);
      }


    </style>
    <div class="container">
      <h2>Registrate</h2>
        <ul><li><span>Ingresa tus datos personales:</span></li></ul>
        <iron-form id="formregister">
         <form method="GET" action="#">
            <paper-input label="Nombre" value='{{name}}' required auto-validate></paper-input>
            <paper-input label="Email" value='{{email}}' required pattern="[^@\s]+@[^@\s]+\.[^@\s]+" auto-validate></paper-input>
            <paper-input label="Teléfono" value='{{phoneNumber}}' required maxlength="10" char-counter allowed-pattern="[0-9]" auto-validate></paper-input>
            <paper-input label="Dirección" value='{{address}}' required auto-validate></paper-input>
            <paper-input label="Fecha de nacimiento" value='{{birthDate}}'  type="date" required auto-validate></paper-input>
            <br>
            <ul><li><span>Ingresa los datos con los que podrás iniciar sesión</span></li></ul>
            <paper-checkbox class="blue" on-tap="_validCheck">Usar mi correo como usuario de acceso</paper-checkbox>
            <paper-input class="username" label="Usuario" value='{{username}}' required auto-validate></paper-input>
            <paper-input type="password" name="password" label="Contraseña" value='{{password}}' maxlength="10" char-counter required allowed-pattern="[A-Za-z0-9]" auto-validate></paper-input>
            <br>
            <paper-button raised class="indigo" on-click="_submitRegister">Registrar</paper-button>
            <a href='login.html' class='return'>Regresar</a>
        </form>
      </iron-form>
      <div class="loader"></div>
      <div class="success"></div>
      <div class="error"></div>
    </div>
  </template>

  <script>
    class SignIn extends Polymer.Element {
      static get is() { return 'sign-in'; }
      static get properties() {
        return {
          email: String,
          name: String,
          phoneNumber: String,
          address: String,
          birthDate: String,
          username: String,
          password: String,
          endpoint: {
            type: String,
            value: 'https://project-gio.herokuapp.com',
            readOnly: true
          },
          pathUsers: {
            type: String,
            value: '/users/v0/users',
            readOnly: true
          },
          pathValidate: {
            type: String,
            value: '/users/v0/validate',
            readOnly: true
          },
          pathClients: {
            type: String,
            value: '/clients/v0/clients',
            readOnly: true
          },
        };
      }
      _validCheck(e){
        var shadow = this.shadowRoot;
        var error = shadow.querySelector('.error');
        error.style.display = "none";
        if (this.email !== undefined && this.email !== ''){
          if (e.target.checked){
            this.username = this.email;
          }else{
            this.username = '';
          } 
        }else{
          error.style.display = "block";
          error.innerHTML = "Debes ingresar un email";
          e.target.checked = false;
        }
      }
      _submitRegister(){        
        var shadow = this.shadowRoot;
        var success = shadow.querySelector('.success');
        var error = shadow.querySelector('.error'); 
        success.style.display = "none";
        error.style.display = "none";
        var form1 = this.$.formregister;
        this.existUser = true;
        if (form1.validate()){
          var dataX = {
            name: this.name,
            phoneNumber: this.phoneNumber,
            address: this.address,
            birthDate: this.birthDate,
            username: this.username,
            password: this.password,
            email: this.email,
            type: 'U'
          };
          var loader = shadow.querySelector('.loader');
          loader.style.display = "block";
          this.validUser(function(data){
            if (data.code == 'TIMEOUT'){
              error.style.display = "block";
              error.innerHTML = "Ocurrió un error al procesar tu solicitud. Intenta mas tarde.";
            }else{
              if (data.status !== 200){
                error.style.display = "block";
                error.innerHTML = data.message;
                shadow.querySelector('.username').value = '';
                shadow.querySelector('.username').focus();      
              }else{
                this.addClientUser(dataX, function(data2){
                  if (data.status !== 200){
                    error.style.display = "block";
                    error.innerHTML = data2.message;
                  }else{
                    success.style.display = "block";
                    success.innerHTML = data2.message;
                    sessionStorage.clientId = '';
                    setTimeout(function(){
                      setTimeout(function(){location.href="/login.html"} , 100); 
                      FreezeUI({ text: 'Espere...' }); 
                    } , 1500); 
                  }
                });
              }
            }   
            loader.style.display = "none";
          }.bind(this));
          
        }             
      }
      validUser(callback){ 
        var params = "?username=" + this.username;
        var xhttp = new XMLHttpRequest();
        xhttp.open("GET", this.endpoint + this.pathValidate + params, true);
        xhttp.timeout = 5000;
        xhttp.send();
        xhttp.onload = function() {
          if (xhttp.readyState === 4) {
            var data = JSON.parse(xhttp.responseText);
            data.status = xhttp.status;
            return callback(data);        
          } 
        }
        xhttp.ontimeout = function () {
          var data = {
            code: 'TIMEOUT'
          };
          callback(data);
        };
      }

      addClientUser(obj, callback){
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", this.endpoint + this.pathClients, false);
        xhttp.setRequestHeader('Content-Type', 'application/json'); 
        xhttp.withCredentials = true;
        xhttp.send(JSON.stringify(obj));
        if (xhttp.status === 200) {
          var data = JSON.parse(xhttp.responseText);
          data.status = xhttp.status;
          callback(data);
        }
      }
    }

    window.customElements.define(SignIn.is, SignIn);
  </script>
</dom-module>
<script src="../FreezeUI/freeze-ui.min.js"></script>